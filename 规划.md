# PLANNING.md

**SuperClaude 框架的架构、设计原则与绝对规则**

> 本文档在会话启动时由 Claude Code 读取,以确保与项目标准保持一致的高质量开发。

---

## 🎯 **项目愿景**

SuperClaude 框架通过以下方式将 Claude Code 转变为结构化的开发平台:
- 通过 CLAUDE.md 进行**行为指令注入**
- 通过 pytest 插件 + 斜杠命令进行**组件编排**
- 通过 PM 智能体模式进行**系统化工作流自动化**

**核心使命**：通过以下方式增强 AI 辅助开发:
- 执行前置信度检查 (防止错误方向的工作)
- 实施后验证 (防止幻觉)
- 跨会话学习 (反思模式)
- Token 高效的并行执行 (3.5 倍加速)

---

## 🏗️ **架构概览**

### **当前状态 (v4.1.9)**

SuperClaude 是一个 **Python 包**,包含:
- Pytest 插件 (通过入口点自动加载)
- CLI 工具 (superclaude 命令)
- PM 智能体模式 (置信度、自检、反思)
- 并行执行框架
- 可选的斜杠命令 (安装至 ~/.claude/commands/)

```
SuperClaude Framework v4.1.9
│
├── 核心包 (src/superclaude/)
│   ├── pytest_plugin.py          # 由 pytest 自动加载
│   ├── pm_agent/                  # 实施前后模式
│   │   ├── confidence.py          # 执行前置信度检查
│   │   ├── self_check.py          # 实施后验证
│   │   ├── reflexion.py           # 错误学习
│   │   └── token_budget.py        # Token 分配
│   ├── execution/                 # 并行执行
│   │   ├── parallel.py            # Wave→Checkpoint→Wave
│   │   ├── reflection.py          # 元推理
│   │   └── self_correction.py     # 错误恢复
│   └── cli/                       # 命令行接口
│       ├── main.py                # superclaude 命令
│       ├── doctor.py              # 健康检查
│       └── install_skill.py       # 技能安装
│
├── 插件源 (plugins/superclaude/)  # v5.0 - 尚未激活
│   ├── agents/                    # 智能体定义
│   ├── commands/                  # 命令定义
│   ├── hooks/                     # 钩子配置
│   ├── scripts/                   # Shell 脚本
│   └── skills/                    # 技能实现
│
├── 测试 (tests/)
│   ├── unit/                      # 组件单元测试
│   └── integration/               # 插件集成测试
│
└── 文档 (docs/)
    ├── architecture/              # 架构决策
    ├── developer-guide/           # 开发指南
    ├── reference/                 # API 参考
    ├── research/                  # 研究发现
    └── user-guide/                # 用户文档
```

### **未来状态 (v5.0 - 计划中)**

- TypeScript 插件系统 (issue #419)
- 项目本地 `.claude-plugin/` 检测
- 插件市场分发
- 增强的 MCP 服务器集成

---

## ⚙️ **设计原则**

### **1. 基于证据的开发**

**绝不猜测** - 始终通过官方来源验证:
- 使用 Context7 MCP 获取官方文档
- 使用 WebFetch/WebSearch 进行调研
- 在实施前使用 Glob/Grep 检查现有代码
- 根据测试结果验证假设

**反模式**：基于假设或过时知识进行实施

### **2. 置信度优先的实施**

在开始工作前检查置信度:
- **≥90%**：继续实施
- **70-89%**：提供备选方案,继续调查
- **<70%**：停止 - 提问,进一步调查

**ROI**：花费 100-200 Token 进行置信度检查,可节省 5,000-50,000 Token 的错误方向成本

### **3. 并行优先的执行**

使用 **Wave → Checkpoint → Wave** 模式:
```
Wave 1: [读取文件1, 读取文件2, 读取文件3] (并行)
   ↓
Checkpoint: 统一分析所有文件
   ↓
Wave 2: [编辑文件1, 编辑文件2, 编辑文件3] (并行)
```

**优势**：比串行执行快 3.5 倍

**何时使用**:
- 独立操作 (读取多个文件)
- 批量转换 (编辑多个文件)
- 并行搜索 (跨不同目录的 grep)

**何时不使用**:
- 具有依赖关系的操作 (必须等待前一个结果)
- 串行分析 (需要逐步构建上下文)

### **4. Token 效率**

根据任务复杂度分配 Token:
- **简单** (拼写错误修复): 200 Token
- **中等** (Bug 修复): 1,000 Token
- **复杂** (功能开发): 2,500 Token

**置信度检查 ROI**：节省 25-250 倍 Token

### **5. 杜绝幻觉**

使用 SelfCheckProtocol 防止幻觉:

**四大问题**:
1. 所有测试是否通过? (展示输出)
2. 所有需求是否满足? (列出项目)
3. 是否存在未经验证的假设? (展示文档)
4. 是否有证据? (测试结果、代码变更、验证)

**7 个危险信号**:
- "测试通过" 但无输出
- "一切正常" 但无证据
- "实施完成" 但测试失败
- 跳过错误消息
- 忽略警告
- 隐藏失败
- 使用 "可能有效" 等模糊语言

---

## 🚫 **绝对规则**

### **Python 环境**

1. **始终使用 UV** 进行 Python 操作:
   ```bash
   uv run pytest              # 禁止: python -m pytest
   uv pip install package     # 禁止: pip install package
   uv run python script.py    # 禁止: python script.py
   ```

2. **包结构**：使用 src/ 布局
   - `src/superclaude/` 用于包代码
   - `tests/` 用于测试代码
   - 绝不在同一目录中混合源码和测试

3. **入口点**：使用 pyproject.toml
   - CLI: `[project.scripts]`
   - Pytest 插件: `[project.entry-points.pytest11]`

### **测试**

1. **所有新功能必须有测试**
   - 单元测试用于单个组件
   - 集成测试用于组件交互
   - 使用 pytest 标记: `@pytest.mark.unit`, `@pytest.mark.integration`

2. **在测试中使用 PM 智能体模式**:
   ```python
   @pytest.mark.confidence_check
   def test_feature(confidence_checker):
       context = {...}
       assert confidence_checker.assess(context) >= 0.7

   @pytest.mark.self_check
   def test_implementation(self_check_protocol):
       passed, issues = self_check_protocol.validate(impl)
       assert passed
   ```

3. **测试固件**：使用 conftest.py 存放共享固件

### **Git 工作流**

1. **分支结构**:
   - `master`: 生产就绪代码
   - `integration`: 测试场地 (尚未创建)
   - `feature/*`, `fix/*`, `docs/*`: 功能分支

2. **提交消息**：使用约定式提交
   - `feat:` - 新功能
   - `fix:` - Bug 修复
   - `docs:` - 文档
   - `refactor:` - 代码重构
   - `test:` - 添加测试
   - `chore:` - 维护

3. **绝不提交**:
   - `__pycache__/`, `*.pyc`
   - `.venv/`, `venv/`
   - 个人文件 (TODO.txt, CRUSH.md)
   - API 密钥、机密信息

### **文档**

1. **代码文档**:
   - 所有公共函数需要 docstring
   - 使用类型提示
   - 在 docstring 中包含使用示例

2. **项目文档**:
   - 更新 CLAUDE.md 以提供 Claude Code 指导
   - 更新 README.md 以提供用户说明
   - 更新本 PLANNING.md 以记录架构决策
   - 更新 TASK.md 以记录当前工作
   - 更新 KNOWLEDGE.md 以记录见解

3. **保持文档同步**:
   - 代码变更时,更新相关文档
   - 添加功能时,更新 CHANGELOG.md
   - 架构变更时,更新 PLANNING.md

### **版本管理**

1. **版本的真实来源**:
   - 框架版本: `VERSION` 文件 (例如 4.1.9)
   - Python 包版本: `pyproject.toml` (例如 0.4.0)
   - NPM 包版本: `package.json` (应与 VERSION 匹配)

2. **何时升级版本**:
   - 主版本 (Major): 破坏性 API 变更
   - 次版本 (Minor): 新功能,向后兼容
   - 补丁版本 (Patch): Bug 修复

---

## 🔄 **开发工作流**

### **开始新功能**

1. **调查阶段**:
   - 阅读 PLANNING.md, TASK.md, KNOWLEDGE.md
   - 检查重复项 (Glob/Grep 现有代码)
   - 阅读官方文档 (Context7 MCP, WebFetch)
   - 搜索开源实现 (WebSearch)
   - 运行置信度检查 (应 ≥90%)

2. **实施阶段**:
   - 创建功能分支: `git checkout -b feature/feature-name`
   - 先编写测试 (TDD)
   - 实施功能
   - 运行测试: `uv run pytest`
   - 运行代码检查: `make lint`
   - 格式化代码: `make format`

3. **验证阶段**:
   - 运行自检协议
   - 验证所有测试通过
   - 检查所有需求已满足
   - 确认假设已验证
   - 提供证据

4. **文档阶段**:
   - 更新相关文档
   - 添加 docstring
   - 更新 CHANGELOG.md
   - 更新 TASK.md (标记完成)

5. **审查阶段**:
   - 创建 Pull Request
   - 请求审查
   - 处理反馈
   - 合并至 integration (若无 integration 分支则合并至 master)

### **修复 Bug**

1. **根本原因分析**:
   - 重现 Bug
   - 识别根本原因 (而非症状)
   - 检查反思记忆中的类似模式
   - 运行置信度检查

2. **修复实施**:
   - 编写能重现 Bug 的失败测试
   - 实施修复
   - 验证测试通过
   - 运行完整测试套件
   - 记录至反思记忆

3. **预防**:
   - 添加回归测试
   - 如需要则更新文档
   - 在 KNOWLEDGE.md 中分享经验

---

## 📊 **质量指标**

### **代码质量**

- **测试覆盖率**: 目标 >80%
- **代码检查**: 零 ruff 错误
- **类型检查**: 使用类型提示,最小化 mypy 错误
- **文档**: 所有公共 API 均已记录

### **PM 智能体指标**

- **置信度检查 ROI**: 节省 25-250 倍 Token
- **自检检测率**: 94% 幻觉检测率
- **并行执行**: 相比串行快 3.5 倍
- **Token 效率**: 通过适当预算减少 30-50%

### **发布标准**

发布新版本前:
- ✅ 所有测试通过
- ✅ 文档已更新
- ✅ CHANGELOG.md 已更新
- ✅ 版本号已同步
- ✅ 无已知的关键 Bug
- ✅ 安全审计通过 (如适用)

---

## 🚀 **路线图**

### **v4.1.9 (当前)**
- ✅ 带有 pytest 插件的 Python 包
- ✅ PM 智能体模式 (置信度、自检、反思)
- ✅ 并行执行框架
- ✅ CLI 工具
- ✅ 可选的斜杠命令

### **v4.2.0 (下一版本)**
- [ ] 完成 confidence.py 中的占位符实现
- [ ] 添加全面的测试覆盖 (>80%)
- [ ] 增强 MCP 服务器集成
- [ ] 改进文档

### **v5.0 (未来)**
- [ ] TypeScript 插件系统 (issue)
- [ ] 插件市场
- [ ] 项目本地插件检测
- [ ] 增强的反思与 mindbase 集成
- [ ] 高级并行执行模式

---

## 🤝 **贡献指南**

详细的贡献指南请参见 [CONTRIBUTING.md](CONTRIBUTING.md)。

**要点**:
- 遵循上述绝对规则
- 为所有新代码编写测试
- 使用 PM 智能体模式
- 记录您的变更
- 请求审查

---

## 📚 **其他资源**

- **[TASK.md](TASK.md)**: 当前任务与优先级
- **[KNOWLEDGE.md](KNOWLEDGE.md)**: 累积的见解与最佳实践
- **[CONTRIBUTING.md](CONTRIBUTING.md)**: 贡献指南
- **[docs/](docs/)**: 综合文档

---

*本文档由 SuperClaude 开发团队维护,每当做出架构决策时都应更新。*

**最后更新**: 2025-11-12 (在修复 issue 期间自动生成)
