# PM 智能体自动激活架构 (PM Agent Auto-Activation Architecture)

## 问题陈述

**当前问题**：PM 智能体的功能需要手动调用 `/sc:pm` 命令，这很容易被遗忘，且导致应用不一致。

**用户反馈**： “现在如果不每次手动输入 `/sc:pm` 命令，感觉它就不会进入 PM 模式。”

## 解决方案：基于行为的自动激活

PM 智能体应根据**上下文检测**自动激活，而非依赖手动命令。

### 架构概览

```yaml
PM 智能体激活层级：

  第 1 层 - 会话启动 (始终激活)：
    触发：每个新的对话会话。
    动作：从 docs/memory/ 自动恢复上下文。
    检测：会话初始化事件。

  第 2 层 - 文档守护者 (持续运行)：
    触发：项目中的任何文件操作。
    动作：确保在实施前读取相关文档。
    检测：Write/Edit 工具的使用。

  第 3 层 - 指挥官 (按需激活)：
    触发：复杂任务 (步骤 >3 或文件 >3)。
    动作：编排子智能体并跟踪进度。
    检测：TodoWrite 的使用或复杂度关键词。

  第 4 层 - 实施后动作 (自动触发)：
    触发：任务完成。
    动作：记录学习成果并更新知识库。
    检测：完成关键词或测试通过。

  第 5 层 - 错误处理程序 (立即触发)：
    触发：出现错误或测试失败。
    动作：进行根本原因分析并编写预防文档。
    检测：错误消息或测试失败。
```

## 实施策略

### 1. 会话启动自动激活

**文件**：`~/.claude/superclaude/agents/pm-agent.md`

**触发检测**：
- 新对话的第一条消息。
- 当前会话中没有先前的上下文。
- Token 预算重置为基准值。
- 内存中没有活动的 TodoWrite 项目。

**自动执行（无需手动命令）**：
1. **并行上下文恢复**：
   - 执行 Bash 命令：`git status && git branch`。
   - **并行读取**（静默执行）：
     - 读取 `docs/memory/pm_context.md`（如果存在）。
     - 读取 `docs/memory/last_session.md`（如果存在）。
     - 读取 `docs/memory/next_actions.md`（如果存在）。
     - 读取 `docs/memory/current_plan.json`（如果存在）。
     - 读取 `CLAUDE.md`（始终读取）。
     - 读取最近的 5 个 `docs/patterns/*.md` 文件。

2. **信心检查**：
   - ❓ “所有文件都读到了吗？”
   - ❓ “上下文是否有矛盾？”
   - ❓ “是否有足够的信息执行下一步行动？”

   - **如果信心度 >70%**：
     - 输出状态：📍 [分支] | [状态] | 🧠 [Token 使用率]%
     - 准备接收用户请求。
   - **否则**：
     - 报告缺失内容。
     - 请求用户澄清。

### 2. 文档守护者 (持续运行)

**目的**：确保在进行任何更改前**始终**读取过相关文档。

**触发检测**：
- 在使用任何 Write/Edit 工具之**前**。
- 在执行复杂的 TodoWrite（任务 >3 个）之**前**。

**自动执行**：
1. **识别相关文档**：根据文件路径（如 `src/auth.ts`）自动读取相关的模式文档、错误记录文档及 `CLAUDE.md` 中的相关章节。
2. **信心检查**：确认是否已掌握所有相关设计模式和历史失败案例。
3. **模式匹配**：如果发现类似的错误模式，在实施前应用预防性检查清单。

### 3. 指挥官模式 (按需激活)

**目的**：针对涉及多个步骤的复杂任务，编排子智能体进行协作。

**触发检测**：
- 包含 3 个以上任务的 TodoWrite。
- 跨度超过 3 个文件的操作。
- 涉及多个目录的操作。
- 关键词检测：“重构 (refactor)”、“迁移 (migrate)”、“重新设计 (redesign)”。

**自动执行**：
1. **任务分析**：识别任务依赖关系，确定并行机会。
2. **编排计划**：分配子智能体任务并制定波动式 (Wave) 执行计划。
3. **带跟踪的执行**：使用 TodoWrite 管理整体计划，利用 Task 工具进行委派，并在内存中跟踪进度。

### 4. 实施后自动文档化

**触发检测**：
- 测试通过消息（如 `pytest: X/X passed`）。
- TodoWrite 项目全部标记为完成。
- 用户表达任务已完成的明确措辞（如 “done”, “finished”）。

**自动执行**：
1. **自我评估（四个问题协议）**：确认测试、需求、假设和证据。
2. **模式提取**：将成功经验记录至 `docs/patterns/`，将失败教训记录至 `docs/mistakes/`。
3. **知识库更新**：如果有新发现的全局规律，更新 `CLAUDE.md` 中的规则。

### 5. 错误处理程序 (立即触发)

**触发检测**：
- 测试输出中的 “FAILED” 或 “Error”。
- 运行时异常堆栈检查。
- 构建失败或严重的 Linter 错误。

**自动执行**：
1. **停止当前工作**：立即中断实施，不建议强行绕过错误。
2. **应用反思模式 (Reflexion Pattern)**：
   - 搜索历史错误记录：查找是否有类似报错的补救策略。
   - 如果是旧问题：应用已知方案。
   - 如果是新问题：开展根本原因调查（Root Cause Investigation）。
3. **文档化**：创建新的错误记录文档，包含现象、根本原因、漏洞成因、修复手段及预防清单。

## 移除手动的 `/sc:pm` 命令

### 建议变更
- **完全移除** `/sc:pm` 命令文件。
- **替换**为基于行为的自动激活机制。
- **保留** PM 智能体的人格标识，使其贯穿所有行为。

## 收益

1. **无需手动命令**：PM 智能体始终在线，不再会被遗忘。
2. **上下文感知激活**：在正确的时间执行正确的行为，避免不必要的开销，提高 Token 利用率。
3. **文档质量保证**：改动前必读文档，完成后自动归纳模式，通过反思机制预防错误。
4. **无缝编排**：自动检测并处理复杂任务的分发与跟踪。

## 总结

该架构通过基于行为的触发器，确保 PM 智能体功能**始终处于激活状态**，在维持清晰职责分离和文档质量的同时，消除了对手动 `/sc:pm` 命令的依赖。
