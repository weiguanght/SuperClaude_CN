# è¿ç§»åˆ°ç®€æ´æ’ä»¶æ¶æ„ (Migration to Clean Plugin Architecture)

**æ—¥æœŸ**ï¼š2025-10-21
**çŠ¶æ€**ï¼šè§„åˆ’ â†’ å®æ–½
**ç›®æ ‡**ï¼šé›¶è¶³è¿¹çš„ pytest æ’ä»¶ + å¯é€‰çš„æŠ€èƒ½ç³»ç»Ÿ

---

## ğŸ¯ è®¾è®¡ç†å¿µ

### å˜æ›´å‰ï¼ˆå­˜åœ¨æ±¡æŸ“çš„è®¾è®¡ï¼‰
```yaml
é—®é¢˜ï¼š
  - å®‰è£…åœ¨ ~/.claude/superclaude/ (æ±¡æŸ“äº† Claude Code ç¯å¢ƒ)
  - å¤æ‚çš„ç»„ä»¶/å®‰è£…ç¨‹åºåŸºç¡€è®¾æ–½ (468 è¡Œçš„åŸºç±»)
  - æŠ€èƒ½ (Skills) ä¸å‘½ä»¤ (Commands) æ··æ‚ (å­˜åœ¨ä¸¤ç§æœºåˆ¶)
  - ä½¿ç”¨ setup.py æ‰“åŒ… (å·²åºŸå¼ƒ)

å½±å“ï¼š
  - Claude Code ç›®å½•è¢«æ±¡æŸ“
  - ç»´æŠ¤å›°éš¾
  - æ— æ³•å¹²å‡€åœ°é€šè¿‡ pip å®‰è£…
  - è®©ç”¨æˆ·æ„Ÿåˆ°å›°æƒ‘
```

### å˜æ›´åï¼ˆç®€æ´è®¾è®¡ï¼‰
```yaml
è§£å†³æ–¹æ¡ˆï¼š
  - ä»…åœ¨ site-packages/ ä¸­å­˜æ”¾ Python åŒ…
  - é€šè¿‡å…¥å£ç‚¹ (entry points) å®ç° pytest æ’ä»¶è‡ªåŠ¨å‘ç°
  - å¯é€‰çš„æŠ€èƒ½ (ç”¨æˆ·å¯é€‰æ‹©å®‰è£…)
  - éµå¾ª PEP 517 çš„ src/ å¸ƒå±€ (ç°ä»£æ‰“åŒ…æ–¹å¼)

æ”¶ç›Šï¼š
  âœ… é›¶ ~/.claude/ ç¯å¢ƒæ±¡æŸ“ (é™¤éç”¨æˆ·æƒ³å®‰è£…æŠ€èƒ½)
  âœ… pip install superclaude â†’ pytest è‡ªåŠ¨åŠ è½½
  âœ… æ ‡å‡†çš„ pytest æ’ä»¶æ¶æ„
  âœ… æ¸…æ™°çš„åˆ†ç¦»ï¼šæ ¸å¿ƒé€»è¾‘ vs ç”¨æˆ·é…ç½®
  âœ… æµ‹è¯•ä¿ç•™åœ¨é¡¹ç›®æ ¹ç›®å½• (ä¸è¿›è¡Œå®‰è£…)
```

---

## ğŸ“‚ æ–°ç›®å½•ç»“æ„

```
superclaude/
â”œâ”€â”€ src/                           # PEP 517 æºç å¸ƒå±€
â”‚   â””â”€â”€ superclaude/              # å®é™…çš„åŒ…
â”‚       â”œâ”€â”€ __init__.py           # åŒ…å…ƒæ•°æ®
â”‚       â”œâ”€â”€ __version__.py        # ç‰ˆæœ¬ä¿¡æ¯
â”‚       â”œâ”€â”€ pytest_plugin.py      # â­ pytest å…¥å£ç‚¹
â”‚       â”‚
â”‚       â”œâ”€â”€ pm_agent/             # PM æ™ºèƒ½ä½“æ ¸å¿ƒé€»è¾‘
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ confidence.py     # æ‰§è¡Œå‰ä¿¡å¿ƒæ£€æŸ¥
â”‚       â”‚   â”œâ”€â”€ self_check.py     # å®ç°åéªŒè¯
â”‚       â”‚   â”œâ”€â”€ reflexion.py      # é”™è¯¯å­¦ä¹ æ¨¡å¼
â”‚       â”‚   â”œâ”€â”€ token_budget.py   # Token é¢„ç®—æ„ŸçŸ¥æ“ä½œ
â”‚       â”‚   â””â”€â”€ parallel.py       # å¸¦åæ€çš„å¹¶è¡Œæ‰§è¡Œ
â”‚       â”‚
â”‚       â”œâ”€â”€ cli/                  # CLI å‘½ä»¤
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ main.py           # å…¥å£ç‚¹
â”‚       â”‚   â”œâ”€â”€ install_skill.py  # superclaude install-skill
â”‚       â”‚   â””â”€â”€ doctor.py         # superclaude doctor
â”‚       â”‚
â”‚       â””â”€â”€ skills/               # æŠ€èƒ½æ¨¡æ¿ (é»˜è®¤ä¸å®‰è£…)
â”‚           â””â”€â”€ pm/               # PM æ™ºèƒ½ä½“æŠ€èƒ½
â”‚               â”œâ”€â”€ implementation.md
â”‚               â””â”€â”€ modules/
â”‚                   â”œâ”€â”€ git-status.md
â”‚                   â”œâ”€â”€ token-counter.md
â”‚                   â””â”€â”€ pm-formatter.md
â”‚
â”œâ”€â”€ tests/                        # æµ‹è¯•å¥—ä»¶ (ä¸å®‰è£…)
â”‚   â”œâ”€â”€ conftest.py              # pytest é…ç½® + fixtures
â”‚   â”œâ”€â”€ test_confidence_check.py
â”‚   â”œâ”€â”€ test_self_check_protocol.py
â”‚   â”œâ”€â”€ test_token_budget.py
â”‚   â”œâ”€â”€ test_reflexion_pattern.py
â”‚   â””â”€â”€ test_pytest_plugin.py    # æ’ä»¶é›†æˆæµ‹è¯•
â”‚
â”œâ”€â”€ docs/                         # æ–‡æ¡£
â”‚   â”œâ”€â”€ architecture/
â”‚   â”‚   â””â”€â”€ MIGRATION_TO_CLEAN_ARCHITECTURE.md (æœ¬æ–‡æ¡£)
â”‚   â””â”€â”€ research/
â”‚
â”œâ”€â”€ scripts/                      # å®ç”¨è„šæœ¬ (ä¸å®‰è£…)
â”‚   â”œâ”€â”€ analyze_workflow_metrics.py
â”‚   â””â”€â”€ ab_test_workflows.py
â”‚
â”œâ”€â”€ pyproject.toml               # â­ PEP 517 æ‰“åŒ… + å…¥å£ç‚¹é…ç½®
â”œâ”€â”€ README.md
â””â”€â”€ LICENSE
```

---

## ğŸ”§ å…¥å£ç‚¹ (Entry Points) é…ç½®

### pyproject.toml (æ–°ç‰ˆ)

```toml
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "superclaude"
version = "0.4.0"
description = "é’ˆå¯¹ Claude Code çš„ AI å¢å¼ºå‹å¼€å‘æ¡†æ¶"
readme = "README.md"
license = {file = "LICENSE"}
authors = [
    {name = "Kazuki Nakai"}
]
requires-python = ">=3.10"
dependencies = [
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0",
]

[project.optional-dependencies]
dev = [
    "pytest-benchmark>=4.0.0",
    "scipy>=1.10.0",  # ç”¨äº A/B æµ‹è¯•
]

# â­ pytest æ’ä»¶è‡ªåŠ¨å‘ç°
[project.entry-points.pytest11]
superclaude = "superclaude.pytest_plugin"

# â­ CLI å‘½ä»¤
[project.entry-points.console_scripts]
superclaude = "superclaude.cli.main:main"

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = [
    "-v",
    "--strict-markers",
    "--tb=short",
]
markers = [
    "unit: å•å…ƒæµ‹è¯•",
    "integration: é›†æˆæµ‹è¯•",
    "hallucination: å¹»è§‰æ£€æµ‹æµ‹è¯•",
    "performance: æ€§èƒ½åŸºå‡†æµ‹è¯•",
]

[tool.hatch.build.targets.wheel]
packages = ["src/superclaude"]
```

---

## ğŸ¨ æ ¸å¿ƒç»„ä»¶

### 1. pytest æ’ä»¶å…¥å£ç‚¹

**æ–‡ä»¶**ï¼š`src/superclaude/pytest_plugin.py`

```python
"""
SuperClaude pytest æ’ä»¶

å½“ superclaude è¢«å®‰è£…æ—¶è‡ªåŠ¨åŠ è½½ã€‚
æä¾› PM æ™ºèƒ½ä½“ fixtures å’Œ hooks ä»¥å¢å¼ºæµ‹è¯•ã€‚
"""

import pytest
from pathlib import Path
from typing import Dict, Any

from .pm_agent.confidence import ConfidenceChecker
from .pm_agent.self_check import SelfCheckProtocol
from .pm_agent.reflexion import ReflexionPattern
from .pm_agent.token_budget import TokenBudgetManager


def pytest_configure(config):
    """æ³¨å†Œ SuperClaude æ’ä»¶å’Œæ ‡è®° (markers)"""
    config.addinivalue_line(
        "markers",
        "confidence_check: æ‰§è¡Œå‰ä¿¡å¿ƒè¯„ä¼°"
    )
    config.addinivalue_line(
        "markers",
        "self_check: å®ç°åéªŒè¯"
    )
    config.addinivalue_line(
        "markers",
        "reflexion: é”™è¯¯å­¦ä¹ ä¸é¢„é˜²"
    )


@pytest.fixture
def confidence_checker():
    """ä¿¡å¿ƒæ£€æŸ¥ fixture"""
    return ConfidenceChecker()


@pytest.fixture
def self_check_protocol():
    """è‡ªæ£€åè®® fixture"""
    return SelfCheckProtocol()


@pytest.fixture
def reflexion_pattern():
    """åæ€æ¨¡å¼ fixture"""
    return ReflexionPattern()


@pytest.fixture
def token_budget(request):
    """Token é¢„ç®—ç®¡ç† fixture"""
    # ä»æ ‡è®°ä¸­è·å–æµ‹è¯•å¤æ‚åº¦
    marker = request.node.get_closest_marker("complexity")
    complexity = marker.args[0] if marker else "medium"
    return TokenBudgetManager(complexity=complexity)


@pytest.fixture
def pm_context(tmp_path):
    """
    ä¸ºæµ‹è¯•æä¾› PM æ™ºèƒ½ä½“ä¸Šä¸‹æ–‡çš„ fixture

    åˆ›å»ºä¸´æ—¶è®°å¿†ç›®å½•ç»“æ„ï¼š
    - docs/memory/pm_context.md
    - docs/memory/last_session.md
    - docs/memory/next_actions.md
    """
    memory_dir = tmp_path / "docs" / "memory"
    memory_dir.mkdir(parents=True)

    return {
        "memory_dir": memory_dir,
        "pm_context": memory_dir / "pm_context.md",
        "last_session": memory_dir / "last_session.md",
        "next_actions": memory_dir / "next_actions.md",
    }


def pytest_runtest_setup(item):
    """
    ç”¨äºä¿¡å¿ƒæ£€æŸ¥çš„æµ‹è¯•å‰ç½®é’©å­

    å¦‚æœæµ‹è¯•è¢«æ ‡è®°ä¸º @pytest.mark.confidence_checkï¼Œ
    åˆ™è¿è¡Œæ‰§è¡Œå‰ä¿¡å¿ƒè¯„ä¼°ã€‚
    """
    marker = item.get_closest_marker("confidence_check")
    if marker:
        checker = ConfidenceChecker()
        confidence = checker.assess(item)

        if confidence < 0.7:
            pytest.skip(f"ä¿¡å¿ƒä¸è¶³: {confidence:.0%}")


def pytest_runtest_makereport(item, call):
    """
    ç”¨äºè‡ªæ£€å’Œåæ€çš„æµ‹è¯•åç½®é’©å­

    è®°å½•æµ‹è¯•ç»“æœä»¥ä¾›åæ€å­¦ä¹ ã€‚
    """
    if call.when == "call":
        marker = item.get_closest_marker("reflexion")
        if marker and call.excinfo is not None:
            # æµ‹è¯•å¤±è´¥ - åº”ç”¨åæ€æ¨¡å¼
            reflexion = ReflexionPattern()
            reflexion.record_error(
                test_name=item.name,
                error=call.excinfo.value,
                traceback=call.excinfo.traceback
            )
```

---

## ğŸ“‹ è¿ç§»æ¸…å•

### ç¬¬ä¸€é˜¶æ®µï¼šé‡æ„ (ç¬¬ 1 å¤©)

- [ ] åˆ›å»º `src/superclaude/` ç›®å½•
- [ ] å°†å½“å‰çš„ `superclaude/` ç§»åŠ¨åˆ° `src/superclaude/`
- [ ] åˆ›å»º `src/superclaude/pytest_plugin.py`
- [ ] ä»æŠ€èƒ½ (Skills) ä¸­æå– PM æ™ºèƒ½ä½“é€»è¾‘ï¼š
  - [ ] `pm_agent/confidence.py`
  - [ ] `pm_agent/self_check.py`
  - [ ] `pm_agent/reflexion.py`
  - [ ] `pm_agent/token_budget.py`
- [ ] åˆ›å»º `cli/` ç›®å½•ï¼š
  - [ ] `cli/main.py`
  - [ ] `cli/install_skill.py`
- [ ] åœ¨ `pyproject.toml` ä¸­é…ç½®å…¥å£ç‚¹
- [ ] ç§»é™¤æ—§çš„ `setup.py`
- [ ] ç§»é™¤ `setup/` ç›®å½• (ç»„ä»¶/å®‰è£…ç¨‹åºåŸºç¡€è®¾æ–½)

### ç¬¬äºŒé˜¶æ®µï¼šæµ‹è¯•è¿ç§» (ç¬¬ 2 å¤©)

- [ ] é’ˆå¯¹æ–°ç»“æ„æ›´æ–° `tests/conftest.py`
- [ ] è¿ç§»æµ‹è¯•ä»¥ä½¿ç”¨ pytest æ’ä»¶ fixtures
- [ ] æ·»åŠ  `test_pytest_plugin.py` é›†æˆæµ‹è¯•
- [ ] ä½¿ç”¨ `pytester` fixture è¿›è¡Œæ’ä»¶æµ‹è¯•
- [ ] è¿è¡Œï¼š`pytest tests/ -v` â†’ æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] éªŒè¯ `entry_points.txt` çš„ç”Ÿæˆ

### ç¬¬ä¸‰é˜¶æ®µï¼šå¹²å‡€å®‰è£… (ç¬¬ 3 å¤©)

- [ ] æµ‹è¯•ï¼š`pip install -e .` (å¯ç¼–è¾‘æ¨¡å¼)
- [ ] éªŒè¯ï¼š`pytest --trace-config` æ˜¾ç¤ºå·²åŠ è½½ superclaude æ’ä»¶
- [ ] éªŒè¯ï¼š`~/.claude/` ä¿æŒå¹²å‡€ (æ— æ±¡æŸ“)
- [ ] æµ‹è¯•ï¼š`superclaude doctor` å‘½ä»¤æ­£å¸¸å·¥ä½œ
- [ ] æµ‹è¯•ï¼š`superclaude install-skill pm-agent`
- [ ] éªŒè¯ï¼šæŠ€èƒ½å·²å®‰è£…åˆ° `~/.claude/skills/pm/`

### ç¬¬å››é˜¶æ®µï¼šæ–‡æ¡£æ›´æ–° (ç¬¬ 4 å¤©)

- [ ] é’ˆå¯¹æ–°çš„å®‰è£…è¯´æ˜æ›´æ–° `README.md`
- [ ] ç¼–å†™ pytest æ’ä»¶ä½¿ç”¨æ–‡æ¡£
- [ ] ç¼–å†™ CLI å‘½ä»¤æ–‡æ¡£
- [ ] æ›´æ–° `CLAUDE.md` (é¡¹ç›®æŒ‡ä»¤)
- [ ] ä¸ºç”¨æˆ·åˆ›å»ºè¿ç§»æŒ‡å—

---

## ğŸš€ æ”¶ç›Šæ±‡æ€»

| ç»´åº¦ | å˜æ›´å‰ | å˜æ›´å |
|--------|--------|-------|
| **~/.claude/ æ±¡æŸ“** | âŒ æ€»æ˜¯è¢«æ±¡æŸ“ | âœ… ä¿æŒå¹²å‡€ (é™¤éå®‰è£…äº†æŠ€èƒ½) |
| **æ‰“åŒ…æ–¹å¼** | âŒ setup.py (å·²åºŸå¼ƒ) | âœ… PEP 517 pyproject.toml |
| **pytest é›†æˆ** | âŒ æ‰‹åŠ¨åŠ è½½ | âœ… é€šè¿‡å…¥å£ç‚¹è‡ªåŠ¨å‘ç° |
| **å®‰è£…æ–¹å¼** | âŒ è‡ªå®šä¹‰å®‰è£…ç¨‹åº | âœ… æ ‡å‡† pip install |
| **æµ‹è¯•å­˜æ”¾ä½ç½®** | âŒ å®‰è£…åˆ° site-packages | âœ… ä¿ç•™åœ¨é¡¹ç›®æ ¹ç›®å½• |
| **å¤æ‚åº¦** | âŒ 468 è¡Œçš„ç»„ä»¶åŸºç±» | âœ… ç®€æ´çš„ pytest æ’ä»¶ |
| **ç”¨æˆ·é€‰æ‹©æƒ** | âŒ å¼ºåˆ¶å®‰è£… | âœ… å¯é€‰æŠ€èƒ½ |

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

- [ ] `pip install superclaude` å·¥ä½œæ­£å¸¸ä¸”å¹²å‡€
- [ ] pytest èƒ½å¤Ÿè‡ªåŠ¨å‘ç° superclaude æ’ä»¶
- [ ] `pip install` å `~/.claude/` ä¿æŒåŸæ ·
- [ ] æ‰€æœ‰ç°æœ‰æµ‹è¯•åœ¨æ–°ç»“æ„ä¸‹é€šè¿‡
- [ ] `superclaude doctor` æŠ¥å‘Šå¥åº·çŠ¶æ€
- [ ] æŠ€èƒ½ä½œä¸ºå¯é€‰å®‰è£…ï¼š`superclaude install-skill pm-agent`
- [ ] æ–‡æ¡£å·²æ›´æ–°ä¸”å‡†ç¡®

---

**çŠ¶æ€**ï¼šå‡†å¤‡å¥½å®æ–½ âœ…
**ä¸‹ä¸€æ­¥**ï¼šç¬¬ä¸€é˜¶æ®µ - é‡æ„ä¸º src/ å¸ƒå±€
