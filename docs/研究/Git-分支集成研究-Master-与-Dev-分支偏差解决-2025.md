# Git 分支集成研究：Master 与 Dev 分支偏差解决 (Git Branch Integration Research)

**研究日期**：2025-10-16
**研究课题**：当 master 和 dev 分支均有重要变更且发生偏离（Divergence）时，应采取何种 Git 合并策略？
**置信度**：高 - 基于 Git 官方文档及 2024-2025 行业最佳实践。

---

## 执行摘要 (Executive Summary)

**结论**：当 master 和 dev 分支各自拥有独立的提交并发生偏离时，**使用“合并 (Merge)”是推荐的策略**。这能完整保留开发历史，并为集成决策留下永久记录。

### 现状分析
- **dev 分支**：领先 2 个提交（PM 智能体重构工作）。
- **master 分支**：领先 3 个提交（上游合并 + 文档整理）。
- **状态**：分支架构发生偏离，需要进行协调与同步。

### 推荐方案：两步走合并流程

```bash
# 第一步：用 master 的变更更新 dev
git checkout dev
git merge master  # 将上游更新引入开发分支

# 第二步：待发布就绪时
git checkout master
git merge dev     # 将 PM 智能体的工作集成到主分支
```

---

## 研究结果

### 1. GitFlow 模式 (行业标准)
**核心原则**：
- `dev` (或 `develop`) 分支：用于活跃的开发工作。
- `master` (或 `main`) 分支：用于生产环境就绪的版发布。
- 合并方向：功能分支 → dev 分支 → master 分支。

### 2. 偏离分支的解决策略对比

| 策略 | 命令 | 结果 | 适用场景 |
| :--- | :--- | :--- | :--- |
| **合并 (Merge)** | `git merge` | 创建合并提交，保留所有历史 | **推荐用于保留两端变更** |
| **变基 (Rebase)** | `git rebase` | 线性排列提交，重写历史 | 仅限尚未推送的本地功能开发 |

**为什么选择合并 (Merge)**：
- ✅ 文档化：合并提交标志着集成的具体时间点点。
- ✅ 安全性：不会重写已提交的历史（对共享分支至关重要）。
- ✅ 完整性：分支上的所有努力（即使是微小的修复）都将保留。

### 3. 三路合并 (Three-Way Merge) 机制
Git 在合并时会：
1. 寻找两个分支的共同祖先。
2. 比较两端的变更。
3. 自动合并非冲突部分。
4. 仅在修改了相同代码行时标记为“冲突 (Conflict)”。

### 4. 2024-2025 年行业共识
- **本地分支**：使用 `rebase` 来保持提交历史的整洁。
- **共享/公共分支** (如 dev/master)：使用 `merge` 来确保历史的真实性与可追溯性。

---

## 可操作建议

### 针对当前情况的操作步骤

**步骤 A：同步开发环境 (推荐)**
```bash
git checkout dev
git merge master -m "合并主分支的上游更新"
# 手动解决可能出现的冲突
```

**步骤 B：发布与集成**
```bash
git checkout master
git merge dev -m "Release: 集成 PM 智能体重构工作"
git tag -a v1.x.x -m "发布版本 1.x.x"
```

---

## 避坑指南 (Common Pitfalls)

- ❌ **不要**：在共享分支 (dev/master) 上执行 `rebase` 后强行推送 (`force push`)，这会通过打乱他人的本地历史造成混乱。
- ❌ **不要**：盲目使用 `-Xours` 或 `-Xtheirs` 进行粗暴合并，这可能导致其中一方的辛苦工作被完全覆盖。
- ✅ **务必**：在合并后运行全量测试套件 (`make test`)，确保逻辑集成没有破坏现有功能。

---

## 结论

对于 `dev` 和 `master` 均有重要代码积累的情况，最科学的做法是**先将 master 合并入 dev** 并在开发环境下解决冲突，待测试稳定后再**将 dev 合并回 master** 进行发布。这不仅符合 2025 年的技术规范，也是保障项目长期稳定性的基石。
