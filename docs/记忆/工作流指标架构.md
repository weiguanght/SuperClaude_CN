# 工作流指标架构 (Workflow Metrics Schema)

**目的**：追踪 Token 效率，用于持续优化及 A/B 测试。  
**文件**：`docs/memory/workflow_metrics.jsonl` (仅限追加的日志文件)

## 数据结构 (JSONL 格式)

每一行都是一个完整的 JSON 对象，代表一次工作流执行。

```jsonl
{
  "timestamp": "2025-10-17T01:54:21+09:00",
  "session_id": "abc123def456",
  "task_type": "typo_fix",
  "complexity": "light",
  "workflow_id": "progressive_v3_layer2",
  "layers_used": [0, 1, 2],
  "tokens_used": 650,
  "time_ms": 1800,
  "files_read": 1,
  "mindbase_used": false,
  "sub_agents": [],
  "success": true,
  "user_feedback": "satisfied"
}
```

## 字段定义

### 必填字段
- `timestamp`: 执行时间戳 (ISO 8601)。
- `session_id`: 会话唯一标识符。
- `task_type`: 任务分类 (如 `bug_fix`, `feature_impl`)。
- `complexity`: 意图分类等级 (`light`, `medium`, `heavy` 等)。
- `workflow_id`: 工作流变体标识符。
- `layers_used`: 执行的渐进式加载层级。
- `tokens_used`: 消耗的总 Token 数。
- `time_ms`: 执行耗时（毫秒）。
- `success`: 任务完成状态。

### 可选字段
- `files_read`: 读取的文件数量。
- `sub_agents`: 委派的子智能体列表。
- `user_feedback`: 推断的用户满意度。

## 任务类型分类

### 极轻量级 (Ultra-Light)
- `progress_query`: 询问进度。
- `status_check`: 现状确认。

### 轻量级 (Light)
- `typo_fix`: 修复误字。
- `documentation_update`: 文档更新。

### 中量级 (Medium)
- `bug_fix`: 缺陷修复。
- `refactoring`: 代码重构。

### 重量级 (Heavy)
- `feature_impl`: 新功能实现。
- `architecture_change`: 架构变更。

### 超重量级 (Ultra-Heavy)
- `system_redesign`: 系统重设计。
- `framework_migration`: 框架迁移。

## 复杂度分类规则
通过关键词、Token 预算及加载层级来划分任务复杂度（由极轻量级到超重量级不等）。

## 记录点与循环
PM 智能体会在会话开始、意图分类、渐进式加载、任务完成及会话结束时自动记录指标，无需人工干预。

## 分析与优化
通过每周运行分析脚本，识别高效与低效的工作流模式，并进行 A/B 测试。将表现优异的变体提升为标准流程，而弃用低效方案并记录相关教训。

---

*注意：本数据仅存储于本地，不含代码片段或用户输入内容，确保隐私与安全。*
