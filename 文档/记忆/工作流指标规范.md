# 工作流指标 Schema (Workflow Metrics Schema)

**用途**：Token 效率跟踪，用于持续优化与 A/B 测试
**文件路径**：`docs/memory/workflow_metrics.jsonl` (仅附加型日志)

## 数据结构 (JSONL 格式)

每一行都是一个完整的 JSON 对象，代表一次工作流执行。

```jsonl
{
  "timestamp": "2025-10-17T01:54:21+09:00",
  "session_id": "abc123def456",
  "task_type": "typo_fix",
  "complexity": "light",
  "workflow_id": "progressive_v3_layer2",
  "layers_used": [0, 1, 2],
  "tokens_used": 650,
  "time_ms": 1800,
  "files_read": 1,
  "mindbase_used": false,
  "sub_agents": [],
  "success": true,
  "user_feedback": "satisfied",
  "notes": "可选的实施说明"
}
```

## 字段定义

### 必填字段

| 字段 | 类型 | 说明 | 示例 |
|-------|------|-------------|---------|
| `timestamp` | ISO 8601 | 执行时间戳（JST 格式） | `"2025-10-17T01:54:21+09:00"` |
| `session_id` | 字符串 | 唯一的会话标识符 | `"abc123def456"` |
| `task_type` | 字符串 | 任务分类 | `"typo_fix"`, `"bug_fix"`, `"feature_impl"` |
| `complexity` | 字符串 | 意图分类级别 | `"ultra-light"`, `"light"`, `"medium"`, `"heavy"`, `"ultra-heavy"` |
| `workflow_id` | 字符串 | 工作流变体标识符 | `"progressive_v3_layer2"` |
| `layers_used` | 数组 | 已执行的渐进式加载层级 | `[0, 1, 2]` |
| `tokens_used` | 整数 | 消耗的总 Token 数 | `650` |
| `time_ms` | 整数 | 执行时长（毫秒） | `1800` |
| `success` | 布尔值 | 任务完成状态 | `true`, `false` |

### 可选字段

| 字段 | 类型 | 说明 | 示例 |
|-------|------|-------------|---------|
| `files_read` | 整数 | 读取的文件数量 | `1` |
| `error_search_tool` | 字符串 | 用于错误搜索的工具 | `"mindbase_search"`, `"ReflexionMemory"`, `"none"` |
| `sub_agents` | 数组 | 委派的子智能体 | `["backend-architect", "quality-engineer"]` |
| `user_feedback` | 字符串 | 推断的用户满意度 | `"satisfied"`, `"neutral"`, `"unsatisfied"` |
| `notes` | 字符串 | 实施说明 | `"使用了缓存的方案"` |
| `confidence_score` | 浮点数 | 实施前的信心得分 | `0.85` |
| `hallucination_detected` | 布尔值 | 自检是否发现幻觉信号 | `false` |
| `error_recurrence` | 布尔值 | 是否之前遇到过相同的错误 | `false` |

## 任务类型分类 (Task Type Taxonomy)

### 极轻量级任务 (Ultra-Light)
- `progress_query`：查询进度，如“进展如何？”
- `status_check`：当前状态确认
- `next_action_query`：查询下一步任务

### 轻量级任务 (Light)
- `typo_fix`：修正误字或拼写错误
- `comment_addition`：添加注释
- `variable_rename`：重命名变量
- `documentation_update`：更新文档

### 中等任务 (Medium)
- `bug_fix`：修复 Bug
- `small_feature`：添加小功能
- `refactoring`：重构代码
- `test_addition`：添加测试用例

### 重量级任务 (Heavy)
- `feature_impl`：实现新功能
- `architecture_change`：更改架构
- `security_audit`：安全性审计
- `integration`：集成外部系统

### 极重量级任务 (Ultra-Heavy)
- `system_redesign`：系统全面重新设计
- `framework_migration`：框架迁移
- `comprehensive_research`：全面性调查研究

## 工作流变体标识符

### 渐进式加载变体
- `progressive_v3_layer1`：极轻量（仅加载记忆文件）
- `progressive_v3_layer2`：轻量（仅加载目标文件）
- `progressive_v3_layer3`：中等（加载 3-5 个相关文件）
- `progressive_v3_layer4`：重量（加载整个子系统）
- `progressive_v3_layer5`：极重量（全量加载 + 外部研究）

## 复杂度分类规则

```yaml
ultra_light:
  关键词: ["进度", "状况", "进展", "where", "status", "progress"]
  Token 预算: "100-500"
  层级: [0, 1]

light:
  关键词: ["误字", "typo", "fix typo", "修正", "注释"]
  Token 预算: "500-2K"
  层级: [0, 1, 2]

medium:
  关键词: ["错误", "bug", "fix", "修复", "issue"]
  Token 预算: "2-5K"
  层级: [0, 1, 2, 3]

heavy:
  关键词: ["新功能", "new feature", "implement", "实现"]
  Token 预算: "5-20K"
  层级: [0, 1, 2, 3, 4]

ultra_heavy:
  关键词: ["重新设计", "redesign", "overhaul", "迁移"]
  Token 预算: "20K+"
  层级: [0, 1, 2, 3, 4, 5]
```

## 记录节点 (Recording Points)

1. **会话开始 (Layer 0)**：初始化会话 ID 并生成基础指标。
2. **意图分类后 (Layer 1)**：根据用户请求分类任务类型与复杂度，估算 Token 预算。
3. **渐进式加载后**：记录实际执行的层级、消耗的 Token 数以及读取的文件数。
4. **任务完成后**：记录成功状态、执行时长及用户反馈。
5. **会话结束**：将完整的指标对象附加到 `workflow_metrics.jsonl` 中。

## 分析脚本

### 每周分析
运行脚本按任务类型分组并计算平均值（如平均消耗 Token、平均时长、成功率等）。

### A/B 测试分析
对比不同工作流变体的表现。例如比较 `progressive_v3_layer2` (标准版) 与 `experimental_eager_layer3` (预加载版) 在 Token 消耗上的差异。

## 持续优化使用说明

### 每月清理
1. 识别陈旧的工作流（过去 90 天无使用、成功率低或评价差）。
2. 将已弃用的工作流归档。
3. 提升新的标准（通过 A/B 测试证明更优的变体）。
4. 生成月度报告，展示 Token 效率、成功率及用户满意度的演变趋势。

## 隐私与安全

- **本地存储**：数据仅存储在本地 `docs/memory/` 目录下，不向外部传输。
- **敏感数据处理**：不记录任何代码片段或用户输入的具体内容，仅记录元数据（Token 数、耗时、成功状态）。任务类型使用通用的分类标签。

---

**参考资料**：
- 规范文件：`plugins/superclaude/commands/pm.md`
- 研究报告：`docs/research/llm-agent-token-efficiency-2025.md`
- 测试用例：`tests/pm_agent/test_token_budget.py`
