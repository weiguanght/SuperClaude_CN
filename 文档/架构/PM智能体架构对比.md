# PM 智能体：上游架构 vs 简洁架构 (PM Agent Comparison)

**日期**：2025-10-21
**目的**：对比本家（Upstream）与本次简洁架构（Clean Architecture）在 PM 智能体实现上的差异。

---

## 🎯 概要

### 上游版本 (Upstream) - 基于技能的 PM 智能体
- **位置**：安装在 `~/.claude/skills/pm/`。
- **形式**：Markdown 技能说明 + Python 初始化钩子。
- **加载**：Claude Code 在启动时加载所有的技能定义。

### 本 PR 版本 - 基于核心逻辑的 PM 智能体
- **位置**：存于 `src/superclaude/pm_agent/` Python 包中。
- **形式**：纯 Python 模块。
- **加载**：仅在执行 pytest 时导入所需的模块。

---

## 📂 目录结构对比

### 上游版本 (Upstream)
- **技能侧**：位于 `~/.claude/skills/pm/`，包含大量的 Markdown 文件（约 150KB，合 35K-40K tokens），用于描述工作流、状态格式化及任务管理。
- **核心侧**：位于 `superclaude/core/pm_init/`，包含上下文管理及反思记忆等 Python 钩子。
- **特点**：内容以 Markdown 为中心，人类可读；支持会话启动时的自动激活；由于加载全部 Markdown，Token 消耗较大。

### 本 PR 版本 (简洁架构)
- **核心逻辑**：位于 `src/superclaude/pm_agent/`，包含执行前检查、实施后验证、错误学习及预算管理等纯 Python 模块。
- **测试套件**：位于 `tests/pm_agent/`，包含 79 个测试用例。
- **特点**：以 Python 为首位实现；支持延迟加载（仅导入所需功能）；测试覆盖率高；通过 pytest fixture 轻松调用；不支持自动激活；不自动生成 PDCA 文档。

---

## 🔄 功能对比

### 1. 会话启动协议
- **上游版本**：**自动触发**。每次会话开始时运行初始化钩子，并行读取历史上下文文件。Token 开销约 8.2K。
- **本 PR 版本**：**不自动执行**。需手动从 `pm_agent` 模块调用。通过按需运行，Token 消耗降至约 2K (节省了 75%)。

### 2. 信心检查 (Confidence Check)
- **上游版本**：定义在 Markdown 定义中，输出 Markdown 格式。
- **本 PR 版本**：作为 Python 类 (`ConfidenceChecker`) 实现。可进行自动化测试，支持类型安全，可作为 pytest fixture 使用。

### 3. 实施后自检 (Self-Check)
- **上游版本**：基于 Markdown 检查清单。
- **本 PR 版本**：实现为 Python 协议 (`SelfCheckProtocol`)。包含对“幻觉危险信号”的检测逻辑，并配备了 16 个测试用例。

---

## 📊 Token 消耗对比 (典型场景)

| 阶段 | 上游版本 | 本 PR 版本 | 削减量 |
|---------|----------|---------|------|
| **会话启动** | 8.2K tokens (自动) | 0K (不自动运行) | -8.2K |
| **信心检查** | 0.2K (包含在内) | 2K (按需导入) | +1.8K |
| **自检/反思/预算** | 约 4K-5.5K | 约 4.5K | ~ |
| **总计 (典型会话)** | **12.4K tokens** | **6K tokens** | **-6.4K (52%)** |

**核心改进**：由于移除了会话启动时的强制自动执行，显著降低了基础开销。

---

## ✅ 维持不变的功能
- 执行前信心检查、实施后验证、反思式错误学习、Token 预算分配。
- 支持双重存储 (JSONL + Mindbase)、幻觉检测及 MCP 集成。

## ⚠️ 移除的功能
- **会话启动自动激活**：现在需要用户显式调用或在测试中触发。
- **自动生成 PDCA 文档**：不再自动创建 `docs/pdca/` 下的 Markdown 文件。
- **PM 特有任务工作流**：不再绑定特定的 TodoWrite 自动化脚本。

---

## 🎯 迁移与使用建议

### 场景 1：注重自动化与 PDCA 记录的超级用户
- **建议**：**并用**。保持简洁架构的核心包用于开发，同时安装上游技能用于日常自动激活和文档生成。

### 场景 2：注重性能与测试的开发者 (推荐)
- **建议**：**仅使用核心包**。通过 pytest 驱动开发，最大限度节省 Token。

### 场景 3：追求 100% 兼容性
- **建议**：**仅使用技能版**。维持现有的所有 Markdown 工作流。

---

## 📋 总结

| 维度 | 上游版本 | 本 PR (核心版) |
|------|----------|---------|
| **实现方式** | Markdown + 钩子 | 纯 Python 代码 |
| **位置** | `~/.claude/` | `site-packages/` |
| **Token 消耗** | 12.4K | 6K (降低 52%) |
| **测试覆盖** | 部分 | 79 个测试用例 |
| **自动激活** | ✅ 支持 | ❌ 需手动 |
| **Pytest 集成**| ❌ 不支持 | ✅ Fixture 原生支持 |

**采用本架构的理由**：极大的 Token 节省、标准化的 Python 打包方式以及完备的测试验证。
