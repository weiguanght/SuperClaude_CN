# Claude Code 会话历史管理研究 (Conversation History Management Research)

**研究日期**：2025-10-09
**目的**：理解 `.jsonl` 文件结构、性能影响，并建立历史记录轮转策略。

---

## 1. 结构与目的

### .jsonl 文件结构
**位置**：`~/.claude/projects/{项目目录}/`

**数据结构**：
```json
{
  "type": "summary|file-history-snapshot|user|assistant|system|tool_use|tool_result|message",
  "timestamp": "ISO-8601 时间戳",
  "cwd": "当前工作目录绝对路径",
  "sessionId": "UUID",
  "gitBranch": "分支名称",
  "content": "消息内容或命令",
  "messageId": "消息 ID"
}
```

### 文件历史快照 (File History Snapshot) 的作用
- 记录特定对话点的文件状态。
- 支持文件更改的撤销/重做 (Undo/Redo) 功能。
- 提供编辑回滚能力。

### 会话加载行为
- **自动保存**：所有对话均自动本地保存完整消息历史。
- **上下文恢复**：恢复会话时，整个消息历史都会被加载以维持上下文。
- **恢复命令**：
  - `--continue`：自动继续最近的一次对话。
  - `/resume`：显示最近的会话列表供选择。

---

## 2. 性能影响

### 已知的 GitHub 相关 Issue

#### Issue #5024：历史积累导致性能下降
- **现象**：文件大小增长至数百 MB，导致应用启动变慢，系统性能下降。
- **现状**：官方尚无自动清理机制。

#### Issue #7985：严重的内存泄漏
- **现象**：上下文积累导致巨大的内存使用，长会话变得无法使用。

#### Issue #8839：会话压缩失败
- **现象**：Claude Code 无法自动压缩长对话，导致出现“对话过长”的错误。

#### Issue #8755：/clear 命令失效
- **现象**：部分用户的 `/clear` 命令无法正常清理上下文窗口。

---

## 3. 官方数据保留策略

### 标准保留 (个人版)
- **提示/响应**：在后端日志中保存最多 30 天。
- **已删除聊天**：从 UI 中立即移除，30 天内从后端清除。

### 企业版控制
- **最小保留期**：30 天。
- **自定义周期**：企业组织可根据需要自定义。

### 本地存储 (无官方策略)
- 官方未提供针对本地 `.jsonl` 文件的保留期建议或自动清理工具。

---

## 4. 最佳实践 (官方与社区建议)

### 官方建议
1. **频繁使用 `/clear`**：在不同任务之间重置上下文窗口，防止“上下文污染”。
2. **限定对话范围**：每个对话只针对一个项目或功能特性。
3. **不要过度依赖长上下文**：过长的上下文会降低性能。

### CLAUDE.md 策略
- **持久化上下文**：使用 `CLAUDE.md` 文件存放稳定的指令。
- **实验与优化**：通过实验确定哪些指令能产生最佳结果。

---

## 5. 建议的历史记录轮转策略

### 立即行动 (无风险)
- **清理极旧对话 (>30 天)**：
  - 将 30 天前的文件归档到备份目录。
  - 理由：30 天前的上下文很少再有参考价值，且节省空间。

### 定期维护 (每周)
- **识别大文件进行人工审核**：
  - 查找大于 1MB 且超过 7 天未访问的文件。
  - 对于已完成的任务或已解决的调试会话，进行归档。

### 紧急清理 (出现性能问题时)
- **仅保留最近一周**：
  - 在完全备份后，删除 7 天前的所有 `.jsonl` 文件。
  - 适用场景：启动时间超过 10 秒或内存占用异常高。

---

## 6. 建议的自动化方案

可以使用 Shell 脚本 (如 `claude-history-rotate.sh`) 配合 Cron Job 或 macOS 的 `launchd` 来定期执行清理：
- 指定 `--days 30` 进行月度清理。
- 将文件重命名并移动到 `projects-archive` 归档目录。

---

## 7. 监控指标

1. **启动时间**：超过 5 秒需排查。
2. **单个文件大小**：单次对话超过 2MB 需审核。
3. **总占用空间**：所有项目总计超过 100MB 需清理。
4. **会话长度**：超过 500 对消息建议运行 `/clear`。

---

## 8. 核心总结与建议

### 关键结论
- ✅ **安全可删除**：超过 30 天的普通对话、已完成特性的对话。
- ⚠️ **需谨慎**：7 天内的活跃项目对话、包含未完成任务的对话。

### 环境维护策略
- **每日**：在重大任务切换时使用 `/clear`。
- **每周**：自检磁盘占用，归档 14 天前的旧对话。
- **每月**：执行强制归档，清理 30 天前的记录。

### 关注官方动态
- 关注是否推出 `claude history prune` 等官方清理工具。
- 关注内存泄漏和会话压缩 Bug 的修复进度。
