# Python 化与技能系统 (Skills) 完全迁移计划 (Complete Python + Skills Migration Plan)

**日期**：2025-10-20
**目标**：通过全量 Python 实施 + 技能系统 (Skills API) 迁移，实现 98% 的 Token 削减。
**时间线**：预计在 3 周内完成。

---

## 现状分析：当前的浪费 (每会话)

```
Markdown 自动加载：41,000 个 Token
其中：
- 项目管理智能体 (PM Agent): 4,050 个 Token
- 各类模式 (Modes): 6,679 个 Token
- 专家智能体 (Agents): 30,000 个以上 Token

结论：每次会话平均浪费 41,000 个 Token。
```

---

## 三周迁移路线图

### 第一周：PM 智能体 Python 化与智能决策

#### 核心任务：PM 智能体核心 Python 逻辑实现
我们将 PM 智能体从被动读取的 Markdown 文档迁移到具有主动逻辑的 Python 代码中。支持功能：
- **自动索引新鲜度检查**：根据 Git 活动自动判断是否更新。
- **预执行置信度检查**：仅在置信度高于 70% 时执行任务。
- **强制性四阶段工作流**：计划 (PLANNING) → 任务列表 (TASKLIST) → 执行 (DO) → 反思 (REFLECT)。

**Token 预期节省**：
- 迁移前：4,050 个 Token（每次读取 Markdown）。
- 迁移后：约 100 个 Token（仅包含 Python 导入头）。
- **节省率：97%**。

### 第二周：全模式 (Modes) Python 化

我们将对所有模式（如编排模式、头脑风暴、内省等）进行 Python 重构。

**以编排模式 (Orchestration Mode) 为例**：
- **资源区自动监测**：根据 Token 占用情况分级 (绿、黄、红) 并自动限制工具能力。
- **强制性工具矩阵**：根据任务类型自动选择最优 MCP 工具。
- **自动并行化触发**：处理 3 个以上文件时自动触发并行处理。

**总体节省预期**：从 6,677 个 Token 削减至 400 个 Token，**降幅达 94%**。

### 第三周：技能系统 (Skills API) 迁移

#### 核心思路：按需加载 (Lazy-load)
利用 Claude Code 的 Skills 机制，将复杂的智能体逻辑打包。

**结构示例**：
- `SKILL.md`：极轻量（约 50 Token），包含触发器和描述。仅在启动时加载。
- `agent.py` / `mode.py`：完整的业务逻辑，仅在实际调用（如 `/sc:pm`）时加载。

**Token 成本对比**：
- 仅加载描述（启动）：约 50 个 Token。
- 全量加载（使用时）：约 2,000 个 Token。
- **如果不使用该功能：Token 开销永久保持在 50 个左右。**

---

## 预期产出对比

### Token 使用量对比

| 状态 | 启动加载量 | 备注 |
| :--- | :--- | :--- |
| **现状 (Markdown)** | 约 41,000 个 | 全量无差别加载 |
| **Python 化之后** | 约 4,500 个 | 主要是 INDEX.md 和导入开销 |
| **技能系统化之后** | 约 3,500 个 | 实现极致的“零足迹”启动 |

**节省结论**：
- 未使用功能时：节省 **91%**。
- 使用功能时：由于按需加载，仍能节省约 **86%**。

### 年度成本节省 (按每年 200 会话计)

- **现状**：约消耗 8,200,000 个 Token，费用约 $16-32。
- **迁移后**：约消耗 700,000 个 Token，费用约 $1.4-2.8。
- **综合节省率：91%**。

---

## 风险评估与对策

- **风险 1：破坏性变更**。对策：将 Markdown 文件移至 `archive/` 目录保留，确保可随时回滚 (Rollback)。
- **风险 2：Skills API 不稳定**。对策：优先保证独立的 Python 逻辑可用，将 Skills 作为可选的优化增强层。

## 成功基准 (Success Criteria)

- ✅ **Token 减少**：相比现状削减 90% 以上。
- ✅ **自动执行**：Python 行为可被自动化测试覆盖。
- ✅ **按需加载 (Lazy-load)**：验证技能系统仅在被调用时加载。
- ✅ **上游贡献**：准备好可提交至官方 Issue #441 的贡献报告。

---

**启动时间**：2025-10-21 当周
**状态**：已就绪，准备开始。
